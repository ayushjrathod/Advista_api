# This is your GitHub Actions workflow file
name: Azure CI/CD Pipeline

# 1. Trigger the workflow on a push to the 'dev' branch
on:
  push:
    branches: [dev]
  workflow_dispatch: # Allows you to run it manually from the Actions tab

jobs:
  # ------------------------------------
  # JOB 1: Build and Push Docker Image
  # ------------------------------------
  build:
    name: Build and Push to ACR
    runs-on: ubuntu-latest
    steps:
      # Check out the repository code
      - name: "Checkout Repo"
        uses: actions/checkout@v4

      # Log in to Azure using the Service Principal secret
      - name: "Azure Login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Build and Push the image using the Azure CLI
      # This is the cloud-native build you learned about
      - name: "ACR Build (Build & Push)"
        run: |
          az acr build \
            --registry ${{ secrets.ACR_NAME }} \
            --image python-api:latest \
            .

  # ------------------------------------
  # JOB 2: Deploy (Restart Container)
  # ------------------------------------
  deploy:
    name: Deploy to ACI
    runs-on: ubuntu-latest
    needs: build # This job won't run until the 'build' job succeeds
    steps:
      # Log in to Azure again for this new job
      - name: "Azure Login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Restart the container to pull the new 'latest' image
      - name: "Restart ACI Container"
        run: |
          az container restart \
            --name ${{ secrets.CONTAINER_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP_NAME }}
